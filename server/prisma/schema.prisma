// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  extensions = [vector]
}

enum UserRole {
  user
  admin
  super_admin
}

enum PlanTier {
  free
  pro
  enterprise
}

enum BillingCycle {
  monthly
  yearly
}

enum SubscriptionStatus {
  active
  cancelled
  expired
  pending
}

enum TransactionStatus {
  pending
  success
  failed
  abandoned
}

enum DocumentType {
  case
  statute
  regulation
  practice_note
  template
}

enum DocumentStatus {
  pending
  processing
  ready
  error
}

enum ChatRole {
  user
  assistant
  system
}

enum NotificationType {
  info
  warning
  error
  success
}

model User {
  id              String    @id @default(uuid()) @db.Uuid
  email           String    @unique
  password        String?   // Hashed password for local auth
  name            String
  role            UserRole  @default(user)
  subscription_id String?   @db.Uuid
  memory          Json      @default("{}")
  preferences     Json      @default("{}")
  reset_token     String?
  reset_token_expiry DateTime?
  created_at      DateTime  @default(now()) @db.Timestamptz
  updated_at      DateTime  @default(now()) @updatedAt @db.Timestamptz

  // Relations
  subscriptions      Subscription[]
  transactions       Transaction[]
  uploaded_documents Document[]
  chats              Chat[]
  chat_sessions      ChatSession[]
  usage_tracking     UsageTracking[]
  feedback           MessageFeedback[]
  shared_conversations SharedConversation[]
  notification_reads NotificationRead[]

  @@map("users")
}

model AppConfig {
  id              String    @id @default(uuid()) @db.Uuid
  smtp_host       String?
  smtp_port       Int?
  smtp_user       String?
  smtp_pass       String?
  smtp_secure     Boolean   @default(false)
  smtp_from       String?
  
  created_at      DateTime  @default(now()) @db.Timestamptz
  updated_at      DateTime  @updatedAt @db.Timestamptz
  
  @@map("app_configs")
}

model Plan {
  id                String       @id @default(uuid()) @db.Uuid
  name              String       @unique
  tier              PlanTier
  features          Json         @default("{}")
  price             Decimal      @default(0) @db.Decimal(10, 2)
  billing_cycle     BillingCycle @default(monthly)
  split_account     String?
  max_documents     Int          @default(10)
  max_chats_per_day Int          @default(50)
  internet_search   Boolean      @default(false)
  ai_drafting       Boolean      @default(false)
  collaboration     Boolean      @default(false)
  legal_citation    Boolean      @default(false)
  case_summarizer   Boolean      @default(false)
  document_export   Boolean      @default(false)
  priority_support  Boolean      @default(false)
  advanced_analytics Boolean     @default(false)
  is_active         Boolean      @default(true)
  created_at        DateTime     @default(now()) @db.Timestamptz
  
  // Relations
  subscriptions     Subscription[]

  @@map("plans")
}

model Subscription {
  id                       String             @id @default(uuid()) @db.Uuid
  user_id                  String             @db.Uuid
  plan_id                  String             @db.Uuid
  status                   SubscriptionStatus @default(active)
  start_date               DateTime           @default(now()) @db.Timestamptz
  end_date                 DateTime?          @db.Timestamptz
  paystack_subscription_code String?
  paystack_customer_code   String?
  auto_renew               Boolean            @default(true)
  created_at               DateTime           @default(now()) @db.Timestamptz
  updated_at               DateTime           @default(now()) @updatedAt @db.Timestamptz

  // Relations
  user         User          @relation(fields: [user_id], references: [id], onDelete: Cascade)
  plan         Plan          @relation(fields: [plan_id], references: [id], onDelete: Restrict)
  transactions Transaction[]

  @@map("subscriptions")
}

model Transaction {
  id                   String            @id @default(uuid()) @db.Uuid
  user_id              String            @db.Uuid
  subscription_id      String?           @db.Uuid
  amount               Decimal           @db.Decimal(10, 2)
  currency             String            @default("NGN")
  paystack_tx_ref      String?           @unique
  paystack_access_code String?
  split_info           Json?
  status               TransactionStatus @default(pending)
  payment_method       String?
  metadata             Json              @default("{}")
  created_at           DateTime          @default(now()) @db.Timestamptz
  updated_at           DateTime          @default(now()) @updatedAt @db.Timestamptz

  // Relations
  user         User          @relation(fields: [user_id], references: [id], onDelete: Cascade)
  subscription Subscription? @relation(fields: [subscription_id], references: [id], onDelete: SetNull)

  @@map("transactions")
}

model Document {
  id            String       @id @default(uuid()) @db.Uuid
  title         String
  description   String?
  type          DocumentType
  file_url      String?
  file_size     BigInt?
  content       String?
  // Unsupported type: vector(3072). Prisma supports this via specific setup but standard type mapping might need adjustment or raw SQL
  // For now we omit embedding in the model definition if using raw queries, or use Unsupported
  embeddings    Unsupported("vector(3072)")?
  metadata      Json         @default("{}")
  jurisdiction  String       @default("nigeria")
  year          Int?
  citation      String?
  tags          String[]
  status        DocumentStatus @default(pending)
  is_public     Boolean      @default(true)
  uploaded_by   String?      @db.Uuid
  created_at    DateTime     @default(now()) @db.Timestamptz
  updated_at    DateTime     @default(now()) @updatedAt @db.Timestamptz

  // Relations
  uploader      User?        @relation(fields: [uploaded_by], references: [id], onDelete: SetNull)
  chunks        DocumentChunk[]

  @@map("documents")
}

model DocumentChunk {
  id            String                     @id @default(uuid()) @db.Uuid
  document_id   String                     @db.Uuid
  content       String
  embedding     Unsupported("vector(3072)")?
  chunk_index   Int
  metadata      Json                       @default("{}")
  created_at    DateTime                   @default(now()) @db.Timestamptz

  // Relations
  document      Document                   @relation(fields: [document_id], references: [id], onDelete: Cascade)

  @@unique([document_id, chunk_index])
  @@map("document_chunks")
}

model Chat {
  id          String   @id @default(uuid()) @db.Uuid
  user_id     String   @db.Uuid
  session_id  String   @db.Uuid
  message     String
  role        ChatRole
  sources     Json     @default("[]")
  metadata    Json     @default("{}")
  tokens_used Int      @default(0)
  model_used  String?
  created_at  DateTime @default(now()) @db.Timestamptz

  // Relations
  user        User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  feedback    MessageFeedback[]
  session     ChatSession @relation(fields: [session_id], references: [id], onDelete: Cascade)

  @@map("chats")
}

model ChatSession {
  id              String   @id @default(uuid()) @db.Uuid
  user_id         String   @db.Uuid
  title           String?
  last_message_at DateTime @default(now()) @db.Timestamptz
  message_count   Int      @default(0)
  is_archived     Boolean  @default(false)
  created_at      DateTime @default(now()) @db.Timestamptz

  // Relations
  user            User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  shared_conversations SharedConversation[]
  chats           Chat[]

  @@map("chat_sessions")
}

model AdminNotification {
  id           String           @id @default(uuid()) @db.Uuid
  title        String
  message      String
  type         NotificationType @default(info)
  target_roles String[]         @default(["user"])
  is_active    Boolean          @default(true)
  created_at   DateTime         @default(now()) @db.Timestamptz
  expires_at   DateTime?        @db.Timestamptz
  
  // Relations
  reads        NotificationRead[]

  @@map("admin_notifications")
}

model NotificationRead {
  id              String            @id @default(uuid()) @db.Uuid
  user_id         String            @db.Uuid
  notification_id String            @db.Uuid
  read_at         DateTime          @default(now()) @db.Timestamptz

  // Relations
  user            User              @relation(fields: [user_id], references: [id], onDelete: Cascade)
  notification    AdminNotification @relation(fields: [notification_id], references: [id], onDelete: Cascade)

  @@unique([user_id, notification_id])
  @@map("notification_reads")
}

model UsageTracking {
  id         String   @id @default(uuid()) @db.Uuid
  user_id    String   @db.Uuid
  feature    String
  count      Int      @default(1)
  date       DateTime @default(dbgenerated("CURRENT_DATE")) @db.Date
  metadata   Json     @default("{}")
  created_at DateTime @default(now()) @db.Timestamptz

  // Relations
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, feature, date])
  @@map("usage_tracking")
}

model MessageFeedback {
  id            String   @id @default(uuid()) @db.Uuid
  user_id       String   @db.Uuid
  message_id    String   @db.Uuid
  feedback_type String
  created_at    DateTime @default(now()) @db.Timestamptz
  updated_at    DateTime @default(now()) @updatedAt @db.Timestamptz

  // Relations
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)
  chat Chat @relation(fields: [message_id], references: [id], onDelete: Cascade)

  @@unique([user_id, message_id])
  @@map("message_feedback")
}

model SharedConversation {
  id          String    @id @default(uuid()) @db.Uuid
  session_id  String    @db.Uuid
  user_id     String    @db.Uuid
  share_token String    @unique
  is_active   Boolean   @default(true)
  expires_at  DateTime? @db.Timestamptz
  created_at  DateTime  @default(now()) @db.Timestamptz
  updated_at  DateTime  @default(now()) @updatedAt @db.Timestamptz

  // Relations
  user    User        @relation(fields: [user_id], references: [id], onDelete: Cascade)
  session ChatSession @relation(fields: [session_id], references: [id], onDelete: Cascade)

  @@map("shared_conversations")
}
